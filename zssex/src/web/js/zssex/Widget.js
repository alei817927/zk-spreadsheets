(function(){function g(k,m,p){var q=k.control,n=k.opts.type=q._dragType,l=p.domTarget,o=jq(k.node),i=jq('<div id="zk_ddghost"></div>').attr("style",o.attr("style")).addClass("zswidget zswidget-drag z-drag-ghost").width(o.width()+"px").height(o.height()+"px");k._orgcursor=document.body.style.cursor;document.body.style.cursor=n=="resize"?"crosshair":"move";if("move"==n){i.appendTo(q._sheet.comp);var j=zk(k.node).revisedOffset();k.opts.innerOffset=[p.pageX-j[0],p.pageY-j[1]];document.body.style.cursor="move"}else{var h=q._panel;if(h=="top"){i.appendTo(q._sheet.tp.$n("topwp"))}else{if(h=="left"){i.appendTo(q._sheet.lp.$n("leftwp"))}else{if(h=="corner"){i.appendTo(q._sheet.cp.$n("cornerwp"))}else{i.appendTo(q._sheet.sp.comp)}}}document.body.style.cursor="crosshair"}jq(q.getDragNode()).addClass("z-dragged");return i[0]}function b(m,l,i){var k=i-m[0],h=l.offsetLeft+l.clientHeight-20;if(k>h){k=h}var j=l.offsetLeft+l.clientWidth-k;return[k,j]}function e(m,j,i){var h=i-m[1],l=j.offsetTop+j.clientHeight-20;if(h>l){h=l}var k=j.offsetTop+j.clientHeight-h;return[h,k]}function d(k,j,h){var i=20;return Math.max(i,h-k[1])}function c(k,j,i){var h=20;return Math.max(h,i-k[0])}function f(I,C,z){var q=I.control,F=q.getDragNode(),D=I.node,k=q._dragType,B=q._dragDir,u=q._focusBorderSize,v=I.opts;if("resize"==k&&B){var o=I.control._sheet,r=o.sp.comp,A=q._focus;if("N"==B){var E=zk(r).revisedOffset(),H=zk(F).revisedOffset(),h=r.scrollTop,i=e(E,F,z.pageY+h),w=i[0],m=i[1];jq(D).height(m+"px");v.x1=H[0]+u;v.x2=v.x1+F.clientWidth-(u*2);v.y1=w+E[1]-h;v.y2=v.y1+m-u;return[D.offsetLeft,w]}else{if("NE"==B){var E=zk(r).revisedOffset(),H=zk(F).revisedOffset(),l=D.offsetLeft,h=r.scrollTop,i=e(E,F,z.pageY+h),w=i[0],m=i[1],t=c(zk(D).revisedOffset(),F,z.pageX);jq(D).height(m+"px").width(t+"px");v.x1=H[0]+u;v.x2=v.x1+t-4;v.y1=w+E[1]-h;v.y2=v.y1+m-u;return[l,w]}else{if("E"==B){var E=zk(D).revisedOffset(),H=zk(F).revisedOffset(),l=D.offsetLeft,w=D.offsetTop,t=c(E,F,z.pageX);jq(D).width(t+"px");v.x1=H[0]+u;v.y1=H[1]+u;v.x2=v.x1+t-4;v.y2=v.y1+F.clientHeight-(u*2);return[l,w]}else{if("SE"==B){var E=zk(D).revisedOffset(),H=zk(F).revisedOffset(),l=D.offsetLeft,w=D.offsetTop,t=c(E,F,z.pageX),m=d(E,F,z.pageY);jq(D).width(t+"px").height(m+"px");v.x1=H[0]+u;v.y1=H[1]+u;v.x2=v.x1+t-4;v.y2=v.y1+m-4;return[l,w]}else{if("S"==B){var E=zk(D).revisedOffset(),H=zk(F).revisedOffset(),l=D.offsetLeft,w=D.offsetTop,m=d(E,F,z.pageY);jq(D).height(m+"px");v.x1=H[0]+u;v.y1=H[1]+u;v.x2=v.x1+F.clientWidth-(u*2);v.y2=v.y1+m-4;return[l,w]}else{if("SW"==B){var E=zk(r).revisedOffset(),H=zk(F).revisedOffset(),m=d(zk(D).revisedOffset(),F,z.pageY),G=r.scrollLeft,L=b(E,F,z.pageX+G),l=L[0],t=L[1];jq(D).width(t+"px").height(m+"px");v.x1=l+E[0]-G;v.y1=H[1]+u;v.x2=v.x1+t-4;v.y2=v.y1+m-4;return[l,F.offsetTop]}else{if("W"==B){var E=zk(r).revisedOffset(),H=zk(F).revisedOffset(),G=r.scrollLeft,L=b(E,F,z.pageX+G),w=F.offsetTop,l=L[0],t=L[1];jq(D).width(t+"px");v.x1=l+E[0]-G;v.y1=H[1]+u;v.x2=v.x1+t-4;v.y2=v.y1+F.clientHeight-(u*2);return[l,w]}else{if("NW"==B){var E=zk(r).revisedOffset(),H=zk(F).revisedOffset(),G=r.scrollLeft,L=b(E,F,z.pageX+G),h=r.scrollTop,i=e(E,F,z.pageY+h),w=i[0],m=i[1],l=L[0],t=L[1];jq(D).width(t+"px").height(m+"px");v.x1=l+E[0]-G;v.y1=w+E[1]-h;v.x2=v.x1+t-4;v.y2=v.y1+m-u;return[l,w]}}}}}}}}}else{var j=I.opts.innerOffset,j=!j?[0,0]:j,o=I.control._sheet,E=zk(o.comp).revisedOffset(),K=o.leftWidth,J=o.topHeight,s=z.pageX-E[0]-j[0],p=z.pageY-E[1]-j[1];if(s>=K){v.x1=Math.max(z.pageX-j[0],K);v.x2=v.x1+F.clientWidth-(u*2)}if(p>=J){v.y1=Math.max(z.pageY-j[1],J);v.y2=v.y1+F.clientHeight-(u*2)}return[s<K?K:s,p<J?J:p]}}function a(v,s){var o=v.control,j=o._dragType,q=o._panel,r=v.opts,l=v.control._sheet,z=l.sheetid,A=l.leftWidth,h=l.topHeight,t=zk(l.dp.comp).revisedOffset(),n=v.node.firstChild,k=l.custColWidth,m=l.custRowHeight,y=zss.SSheetCtrl._calCellPos(l,r.x1,r.y1,j=="resize"&&q=="default"),x=zss.SSheetCtrl._calCellPos(l,r.x2,r.y2,j=="resize"&&q=="default");var i=r.x1-t[0]-A-k.getStartPixel(y[1])+1,p=r.y1-t[1]-h-m.getStartPixel(y[0])+1;var u=x[1]==y[1],w=x[0]==y[0];if(u){dx2=i+(r.x2-r.x1)}else{dx2=r.x2-t[0]-A-k.getStartPixel(x[1])+1}if(w){dy2=p+(r.y2-r.y1)}else{dy2=r.y2-t[1]-h-m.getStartPixel(x[0])+1}o._sheet._wgt.fireWidgetUpdatEvt(o.getType(),v.opts.type,v.control.getId(),Math.round(i),Math.round(p),Math.round(dx2),Math.round(dy2),y[1],y[0],x[1],x[0]);v.control._dragging=false;zcss.removeRule("#"+z+" .zswidget-focus",z+"-sheet")}zssex.Widget=zk.$extends(zul.Widget,{_leftPos:null,_topPos:null,_dragging:false,_delaySetDragMove:null,_dragType:null,_dragDir:null,_focus:false,_focusBorderSize:6,$define:{col:function(){this.adjustLocation()},row:function(){this.adjustLocation()},left:function(){this.adjustLocation()},top:function(){this.adjustLocation()},visible:function(h){var i=this.$n();if(i){jq(i).css("visibility",h?"visible":"hidden")}},sizable:_zkf=function(){this.updateDraggable_()},movable:_zkf,id:null,type:null,panel:null},insertChildHTML_:function(j,h,i){if(h){jq(h).before(j.redrawHTML_())}else{jq(this.$n("real")).append(j.redrawHTML_())}j.bind(i)},adjustLocation:function(s){var i=this.$n(),p=this._sheet;if(!i||!p){return}var j=this.getCol(),t=this.getRow(),q=p.custColWidth,u=p.custRowHeight,m=q.getSize(j),h=u.getSize(t),k=this._leftPos=p.leftWidth+q.getStartPixel(j)+(this.getLeft()>m?m:this.getLeft()),r=this._topPos=p.topHeight+u.getStartPixel(t)+(this.getTop()>h?h:this.getTop()),o=this._focus,l=this._focusBorderSize;jq(i).css({left:o?jq.px(k-l):jq.px(k),top:o?jq.px(r-l):jq.px(r)});if(s){jq(i).css("visibility","visible")}},_cloneAttrs:function(h){if(h._id==this._id){h._sheet=this._sheet;h._leftPos=this._leftPos;h._topPos=this._topPos}},redrawWidgetTo:function(i){if(!i){return}this._sheet=i;var h=this._panel;var j;if(h=="top"){j=i.tp.$n("topwp")}else{if(h=="left"){j=i.lp.$n("leftwp")}else{if(h=="corner"){j=i.cp.$n("cornerwp")}else{j=i.$n("wp")}}}jq(j).append(this.$n());this.clearCache();this.adjustLocation(true);this.updateDraggable_()},updateDraggable_:function(){this.setDraggable(this.isSizable()||this.isMovable())},getDragOptions_:function(h){h.ghosting=g;h.constraint=f;h.endeffect=a;return h},ignoreDrag_:function(j){var h=this._sheet;var i=!this._dragType||(h.state==zss.SSheetCtrl.NOFOCUS&&!this._focus)||h._wgt.isProtect();if(!i&&!this._focus){this._gainFocus()}this._dragging=!i;return i},doBlur_:function(h){jq(this.$n()).removeClass("zswidget-focus").css({left:jq.px(this._leftPos),top:jq.px(this._topPos)});this._updateListenFocus(false)},_onSheetFocus:function(h){var i=h.data;if(i){if(i.ctrl!=this){this.doBlur_()}}else{this.doBlur_()}},doMouseMove_:function(p){if(this._sheet._wgt.isProtect()){this._sheet.dp.reFocus();return}if(!this._dragging){var C=p.domTarget,t=this.$n(),D=this._sheet.sheetid,o=D+"-sheet",z="#"+D;if((C==t||C==this.$n("cave"))&&this.isSizable()){this._dragType="resize";var u=zk(t).revisedOffset(),q=this._focusBorderSize,l=p.pageX-u[0],j=p.pageY-u[1],m=t.clientWidth,v=t.clientHeight,r=q,A=m-q,k=q,i=v-q,s;if(l<=r&&j<=k){s="NW"}else{if(l<=r&&j<=i){s="W"}else{if(l<=r&&j>i){s="SW"}else{if(l<=A&&j<=k){s="N"}else{if(l>A&&j<=k){s="NE"}else{if(l>A&&j<=i){s="E"}else{if(l<=A&&j>i){s="S"}else{if(this._dragDir!="ES"){s="SE"}}}}}}}}if(s!=this._dragDir){this._dragDir=s;zcss.setRule(z+" .zswidget-focus","cursor",s.toLowerCase()+"-resize",true,o)}this._delaySetDragMove=jq.now()}else{if(jq.isAncestor(this.$n("real"),C)){this._dragDir=null;var B=this._delaySetDragMove;if(!B||(B&&(jq.now()-B)>500)){this._delaySetDragMove=null;if(this._dragType!="move"){this._dragType="move";zcss.setRule(z+" .zswidget-focus","cursor","move",null,o)}}}}}},doMouseDown_:function(h){if(this._sheet._wgt.isProtect()){this._sheet.dp.reFocus();return}if(jq.isAncestor(this.$n("real"),h.domTarget)){this._delaySetDragMove=null}if(!this._focus){var i=this._sheet,j=i.state;if(j==zss.SSheetCtrl.EDITING){i.dp.stopEditing()}else{if(j==zss.SSheetCtrl.NOFOCUS){i.dp.gainFocus();return}}this._gainFocus()}},doMouseUp_:function(h){this._dragging=false},_gainFocus:function(){var i=this._sheet,j=jq(this.$n()),h=this._focusBorderSize,l=this._leftPos-h,k=this._topPos-h;j.addClass("zswidget-focus");if(l>0){j.css({left:jq.px(l)})}if(k>0){j.css({top:jq.px(k)})}i.fire("onFocused",{ctrl:this});this._updateListenFocus(true)},afterKeyDown_:function(h){var i=h.data;i.wgt=true;i.wgtType=this._type;i.wgtId=this._id;i.sheetId=this._sheet._wgt.getSheetId();this.$supers("afterKeyDown_",arguments)},_updateListenFocus:function(h){var i=this._focus;if(i!=h){this._sheet[i?"unlisten":"listen"]({onFocused:this.proxy(this._onSheetFocus)});this._focus=h;this.$n("fo")[h?"focus":"blur"]()}},bind_:function(){this.$supers("bind_",arguments)},unbind_:function(){this._updateListenFocus(false);this.$supers("unbind_",arguments)},domClass_:function(h){return"zswidget"}})})();